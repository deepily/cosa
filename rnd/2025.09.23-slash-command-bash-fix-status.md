# Slash Command Bash Execution Fix Status

**Date**: 2025.09.23
**Status**: PARTIALLY COMPLETE - Source prompt files need sync with fixed slash command
**Priority**: HIGH - Source files will regenerate broken slash commands if not fixed

## Problem Discovered

The source prompt files still contain the bash execution bugs that were fixed in the slash command. These files should be kept in sync to prevent regenerating broken slash commands.

## Current Status

### ✅ COMPLETED
- **`.claude/commands/smoke-test-baseline.md`** - Fixed bash execution patterns
  - Fixed TIMESTAMP variable persistence between bash blocks
  - Removed complex multi-command chains causing syntax errors
  - Updated template placeholders to avoid variable expansion issues
- **Testing Infrastructure** - Created comprehensive validation
  - `test-bash-commands.sh` - 13/13 tests passing
  - `mock-cosa-smoke.sh` - Mock COSA test for validation
- **Root Cause Analysis** - Identified and documented the issue
  - Each bash block in slash commands executes independently
  - Variables don't persist between blocks
  - Complex commands with pipes and subshells get mangled during execution

### ❌ NOT YET COMPLETED
- **`src/rnd/prompts/baseline-smoke-test-prompt.md`** - Source prompt still has bugs
- **Consistency Check** - Files should have identical content (except YAML frontmatter)

## Files Needing Updates

### Primary Source File
**`src/rnd/prompts/baseline-smoke-test-prompt.md`** - Needs the same fixes as slash command:
- Move TIMESTAMP generation from Step 3 into Steps 4 and 5 where it's used
- Fix variable persistence issues between bash blocks
- Update report template to avoid variable expansion issues

### Validation Needed
**`src/cosa/rnd/prompts/cosa-baseline-smoke-test-prompt.md`** - Check if it has similar issues (it's COSA-specific)

## Specific Changes Required

### In `src/rnd/prompts/baseline-smoke-test-prompt.md`:

1. **Step 3 (Setup)**: Remove TIMESTAMP generation that won't persist to other blocks
2. **Step 4 (Lupin Tests)**: Add TIMESTAMP generation at start of bash block
3. **Step 5 (CoSA Tests)**: Add TIMESTAMP generation inside the conditional block
4. **Report Template**: Fix any variable expansion placeholders

## Current Problem State

### The Bug Pattern (Still Present in Source File)
```bash
# Step 3 - Sets TIMESTAMP
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# Step 4 - Tries to use ${TIMESTAMP} (FAILS - different bash block)
LOG_FILE="src/tests/logs/baseline_lupin_smoke_${TIMESTAMP}.log"

# Step 5 - Tries to use ${TIMESTAMP} (FAILS - different bash block)
LOG_FILE="src/tests/logs/baseline_cosa_smoke_${TIMESTAMP}.log"
```

### The Fixed Pattern (Already Applied in Slash Command)
```bash
# Each block that needs TIMESTAMP generates it internally
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="src/tests/logs/baseline_lupin_smoke_${TIMESTAMP}.log"
```

## Why This Matters

- **Consistency**: Source prompts and slash commands should be identical
- **Maintenance**: Prevents regenerating broken slash commands from source prompts
- **User Experience**: Avoids future users encountering the same bash execution errors
- **Documentation**: Maintains single source of truth for the prompt logic

## Testing After Fix

- Verify both files have identical prompt content (excluding YAML frontmatter)
- Test that TIMESTAMP is generated in each bash block that uses it
- Confirm no cross-block variable dependencies remain
- Run test harness to validate all bash patterns work correctly

## Error Evidence

The original error that triggered this investigation:
```
/bin/bash: eval: line 1: syntax error near unexpected token `date'
/bin/bash: eval: line 1: `export PYTHONPATH\=/mnt/DATA01/include/www.deepily.ai/projects/genie-in-the-box/src\: && TIMESTAMP\=\$ ( date +%Y%m%d_%H%M%S ) && LOG_FILE\=tests/results/logs/baseline_cosa_smoke_.log...
```

## Next Steps for Tomorrow

1. **Apply fixes to source prompt file** - Make `src/rnd/prompts/baseline-smoke-test-prompt.md` match the fixed slash command
2. **Verify COSA prompt** - Check if `src/cosa/rnd/prompts/cosa-baseline-smoke-test-prompt.md` needs similar fixes
3. **Test consistency** - Ensure source prompts and slash commands remain synchronized
4. **Document relationship** - Add notes about keeping these files in sync for future maintenance

## Files to Work With Tomorrow

- **Primary**: `/mnt/DATA01/include/www.deepily.ai/projects/genie-in-the-box/src/rnd/prompts/baseline-smoke-test-prompt.md`
- **Reference**: `/mnt/DATA01/include/www.deepily.ai/projects/genie-in-the-box/.claude/commands/smoke-test-baseline.md` (already fixed)
- **Validation**: `/mnt/DATA01/include/www.deepily.ai/projects/genie-in-the-box/src/cosa/rnd/prompts/cosa-baseline-smoke-test-prompt.md`
- **Test tools**: `test-bash-commands.sh` and `mock-cosa-smoke.sh` (already created and validated)

---

**IMPORTANT**: The slash command fix is working, but the source prompt will regenerate the broken version if used. Priority fix needed to maintain consistency.